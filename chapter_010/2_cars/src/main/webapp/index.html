<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hibernate avito</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel='stylesheet'
          type='text/css'>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <link href="/resources/css/style.css" rel="stylesheet" type="text/css"/>

    <script>
        $(document).ready(function () {
            var loginCookie = $.cookie("login");
            printItems();
            if (loginCookie === "null" || loginCookie == undefined) {
                document.getElementById("buttonNewAdvert").disabled = true;
            } else {
                document.getElementById('loginText').innerHTML = "<a href='/logout' id='loginText'>Log out</a>";
            }
        });
        function printItems() {
            $.ajax('./advertjson', {
                method: 'get',
                data: {'showAll': document.getElementById('checkboxes-0').checked},
                complete: function (data) {
                    var loginCookie = $.cookie("login");
                    var result = "<thead>"
                        + "<tr>"
                        + "<th style='display: none'>Id</th>"
                        + "<th>Photo</th>"
                        + "<th>Description</th>"
                        + "<th>Brand</th>"
                        + "<th>Model</th>"
                        + "<th>Body</th>"
                        + "<th>Transmission</th>"
                        + "<th>Engine</th>"
                        + "<th>Drive type</th>"
                        + "<th>Author</th>"
                        + "<th>Sold</th>"
                        + "</tr>"
                        + "</thead>"
                        + "<tbody>";
                    var users = JSON.parse(data.responseText);

                    var sold;
                    var photo;
                    for (var i = 0; i != users.length; ++i) {
                        sold = "<td>";
                        if (users[i].sold) {
                            sold += "<input name='btSelectItem' type='checkbox' checked='checked' "
                        } else (
                            sold += "<input name='btSelectItem' type='checkbox' "
                        );
                        if (loginCookie == undefined || loginCookie != users[i].author.login || users[i].sold) {
                            sold += "disabled = 'true' ";
                        }
                        sold += "onclick='updateItem($(this).parent().parent());return false'></td>";
                        if (users[i].photoStr != undefined) {
                            photo = "<td><img src='data:image/png;base64," + users[i].photoStr + "'></td>"
                        } else (
                            photo = "<td></td>"
                        );
                        result += "<tr>"
                            + "<td style='display: none'>" + users[i].id + "</td>"
                            + photo
                            + "<td>" + users[i].description + "</td>"
                            + "<td>" + users[i].carBrand.name + "</td>"
                            + "<td>" + users[i].carModel.name + "</td>"
                            + "<td>" + users[i].carBody.name + "</td>"
                            + "<td>" + users[i].carTransmission.name + "</td>"
                            + "<td>" + users[i].carEngine.name + "</td>"
                            + "<td>" + users[i].carDriveType.name + "</td>"
                            + "<td>" + users[i].author.login + "</td>"
                            + sold
                            + "</tr>";
                    }
                    result += "</tbody>";
                    var table = document.getElementById("advert");
                    table.innerHTML = result;
                }
            });
        }
        function updateItem(row) {
            $.ajax({
                url: "./advertjson",
                method: 'post',
                data: {
                    updateId: row.find('td:first').text()
                },
                success: function (data) {
                    if (data === "true") {
                        printItems();
                    }
                },
                error: function (exception) {
                    console.log('Exception:' + exception);
                }
            });
        }
    </script>
</head>

<body>

<form class="form-horizontal">
    <div class="container">
        <div class="row">
            <p></p>
            <!--<p id="username_message" align="right"></p>-->
            <p align="right"><a href='/login.html' id="loginText">Log in</a></p>
        </div>
    </div>
    <fieldset>
        <legend align="center"></legend>
        <div class="form-group">
            <div class="col-md-4">
                <button id="buttonNewAdvert" type="button" onclick="location.href = 'newadvert'"
                        class="btn btn-lg btn-success pull-right">Place new advert
                </button>
            </div>
        </div>
    </fieldset>
</form>

<div class="container">
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="panel panel-default panel-table">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col col-xs-6">
                            <h1 class="panel-title"><b>My avito</b></h1>
                        </div>
                        <div class="col col-xs-6 text-right">
                            <label for="checkboxes-0">
                                <input type="checkbox" name="checkboxes" id="checkboxes-0"
                                       value="1" onclick="printItems()">
                                Show all
                            </label>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <table class="table table-striped table-bordered table-list" id="advert">
                        <thead>
                        <tr>
                            <!--<th><em class='fa fa-cog'></em></th>-->
                            <th style='display: none'>Id</th>
                            <th>Description</th>
                            <th>Brand</th>
                            <th>Model</th>
                            <th>Body</th>
                            <th>Transmission</th>
                            <th>Engine</th>
                            <th>Drive type</th>
                            <th>Author</th>
                            <th>Sold</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <!--<td>desc</td>-->
                            <!--<td>2017</td>-->
                            <!--<td>-->
                            <!--<input name="btSelectItem" type="checkbox" checked="checked">-->
                            <!--</td>-->
                        </tbody>
                    </table>
                </div>
                <div class="panel-footer">
                </div>
            </div>
        </div>
    </div>
</div>
</body>

</html>